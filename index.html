import React, { useState, useEffect, useMemo, useRef } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Calendar, Users, Clapperboard, UserCheck, ChevronDown, ChevronUp, Clock, BookOpen, School, Printer, PieChart, Share2, Camera, X, Search } from 'lucide-react';

// --- HTML2CANVAS SCRIPT LOADER ---
// This component ensures the html2canvas library is available for the screenshot feature.
const ScriptLoader = ({ onLoaded }) => {
    useEffect(() => {
        if (window.html2canvas) {
            if (onLoaded) onLoaded();
            return;
        }
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        script.onload = () => {
            console.log("html2canvas loaded.");
            if (onLoaded) onLoaded();
        };
        script.onerror = () => console.error("Failed to load html2canvas script.");
        document.body.appendChild(script);
        return () => {
            if (document.body.contains(script)) {
                document.body.removeChild(script);
            }
        };
    }, [onLoaded]);
    return null;
};


// --- DATA STORE ---
const rawData = `
Monday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Home Work (Anjana),Maths (Kusum)
Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu)
Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Hindi (Kusum),Sports (Rakesh)
Class 4,Hindi (Kusum),Home Work (Jainendra),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Sports (Rakesh)
Class 5,Maths (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),CCS (Maya),Maths (Nidhika),EVS (Nidhika)
Class 6,Science (Hemlata),Science (Hemlata),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
Class 7,Hindi (Jainendra),SST (Gyan Sir),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Gyan Sir),Maths (Leena),Science (Hemlata)
Class 8,Hindi (Antima),CCS (Maya),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),Sanskrit (Antima)
Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra),English (Harshita),Maths (Leena)
Class 10,SST (Pradhyuman),Hindi (Antima),Maths (Nathulal),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),Sports (Rakesh)
Class 11 Science,Physics (Phy Sir),Physics (Phy Sir),Biology (Hemlata),English (Pradhyuman),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Sports (Rakesh)
Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),English (Pradhyuman),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Accountancy (Nathulal)
Class 11 Arts,English Literature (Harshita),Geography (Prakash),Economics (Prakash),English (Pradhyuman),CCS (Maya),Sports (Rakesh),English (Pradhyuman),Political Science (Pradhyuman)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy Sir),Physics (Phy Sir),English (Pradhyuman),Biology (Hemlata),Hindi (Jainendra),Physics (Phy Sir)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Business (Pradhyuman),Economics (Prakash),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),CCS (Maya)
Class 12 Arts,Geography (Prakash),English Literature (Harshita),Hindi Boards (Antima),Economics (Prakash),English (Pradhyuman),Political Science (Pradhyuman),Hindi (Jainendra),English Literature (Harshita)

Tuesday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Hindi (Bindu),Home Work (Anjana)
Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
Class 3,EVS (Rashmita),Maths (Anita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Hindi (Kusum),Hindi (Kusum)
Class 4,Hindi (Kusum),Maths (Leena),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Basic Hindi (Anjana),EVS (Anita),EVS (Anita)
Class 5,EVS (Nidhika),Home Work (Rashmita),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Maths (Nidhika),EVS (Nidhika)
Class 6,Science (Hemlata),Sanskrit (Jainendra),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Hindi (Jainendra),SST (Rashmita)
Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Gyan Sir),Maths (Leena),Sanskrit (Antima)
Class 8,Hindi (Antima),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),SST (Harshita)
Class 9,Maths (Leena),English (Harshita),Hindi (Jainendra),CCS (Maya),Science (Toshit),Science (Toshit),Sanskrit (Antima),SST (Pradhyuman)
Class 10,SST (Pradhyuman),CCS (Maya),Maths (Nathulal),Sanskrit (Antima),Hindi (Antima),English (Harshita),Science (Toshit),Maths (Nathulal)
Class 11 Science,Physics (Phy Sir),Physics (Phy Sir),Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
Class 11 Arts,English Literature (Harshita),Political Science (Pradhyuman),Economics (Prakash),Geography (Prakash),CCS (Maya),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Physics (Phy Sir),Biology (Hemlata)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),CCS (Maya),Business (Pradhyuman),Hindi (Jainendra),English (Pradhyuman),Accountancy (Nathulal),Sports (Rakesh)
Class 12 Arts,Geography (Prakash),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Sports (Rakesh)

Wednesday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Home Work (Anjana),Hindi (Bindu),Sports (Rakesh)
Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),Hindi (Bindu),EVS (Rashmita),Sports (Rakesh)
Class 3,EVS (Rashmita),Home Work (Jainendra),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Maths (Anita),Maths (Anita)
Class 4,Hindi (Kusum),EVS (Anita),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Maths (Leena),Maths (Leena),Hindi (Kusum)
Class 5,EVS (Nidhika),EVS (Nidhika),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Hindi (Kusum),Maths (Nidhika)
Class 6,Science (Hemlata),SST (Rashmita),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Science (Hemlata),CCS (Maya)
Class 7,Hindi (Jainendra),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Science (Hemlata),CCS (Maya),SST (Gyan Sir)
Class 8,Sanskrit (Antima),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),English Boards (Rashmita),SST (Harshita),Maths (Leena)
Class 9,Maths (Leena),Maths (Leena),Hindi (Jainendra),Science (Toshit),Sports (Rakesh),Sanskrit (Antima),SST (Pradhyuman),English (Harshita)
Class 10,SST (Pradhyuman),English (Harshita),Science (Toshit),Maths (Nathulal),Sanskrit (Antima),Science (Toshit),Hindi (Antima),Maths (Nathulal)
Class 11 Science,Physics (Phy Sir),Physics (Phy Sir),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata),Sports (Rakesh),Chemistry (Toshit),Chemistry (Toshit)
Class 11 Commerce,CCS (Maya),Economics (Prakash),English (Pradhyuman),Self Study (Maya),Accountancy (Nathulal),Accountancy (Nathulal),Business (Nidhika),Sports (Rakesh)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),English (Pradhyuman),Geography (Prakash),Self Study (Toshit),Political Science (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),Hindi (Jainendra)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),English (Pradhyuman),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra)
Class 12 Arts,Geography (Prakash),Political Science (Pradhyuman),Economics (Prakash),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Hindi (Jainendra),Hindi (Jainendra)

Thursday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,Hindi (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),EVS (Bindu),CCS (Maya),Hindi (Anjana)
Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Home Work (Bindu),Maths (Anita)
Class 4,Hindi (Kusum),CCS (Maya),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Games (Rakesh)
Class 5,EVS (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),Home work (Anjana),Maths (Nidhika),Hindi (Kusum)
Class 6,Science (Hemlata),Maths (Nidhika),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Hindi (Jainendra),Science (Hemlata),SST (Rashmita)
Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Gyan Sir),Sanskrit (Antima),Maths (Leena)
Class 8,Hindi (Antima),SST (Harshita),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Maths (Leena),Science (Hemlata)
Class 9,Maths (Leena),Hindi (Jainendra),SST (Pradhyuman),SST (Pradhyuman),Sanskrit (Antima),Sanskrit (Antima),Science (Toshit),Science (Toshit)
Class 10,SST (Pradhyuman),SST (Pradhyuman),Science (Toshit),Science (Toshit),Maths (Nathulal),Maths (Nathulal),English (Harshita),Sanskrit (Antima)
Class 11 Science,Physics (Phy Sir),Physics (Phy Sir),Biology (Hemlata),Biology (Hemlata),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),English (Pradhyuman)
Class 11 Commerce,CCS (Maya),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Hindi (Jainendra),English (Pradhyuman)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),Geography (Prakash),Self Study (Antima),Political Science (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Physics (Phy Sir),Biology (Hemlata),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),Business (Pradhyuman),English (Pradhyuman),Hindi (Jainendra)
Class 12 Arts,Geography (Prakash),Self Study (Antima),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra)

Friday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,Hindi (Bindu),Hindi (Bindu),Maths (Kusum),EVS (Bindu),Maths (Kusum),CCS (Maya),EVS (Bindu),EVS (Bindu)
Class 2,Maths (Anita),Maths (Anita),Hindi (Bindu),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu),CCS (Maya),EVS (Rashmita)
Class 3,EVS (Rashmita),EVS (Rashmita),Maths (Anita),Maths (Anita),CCS (Maya),Hindi (Kusum),Hindi (Kusum),Home Work (Anjana)
Class 4,Hindi (Kusum),Hindi (Kusum),Home Work (Rashmita),CCS (Maya),Maths (Leena),Maths (Leena),EVS (Anita),EVS (Anita)
Class 5,EVS (Nidhika),EVS (Nidhika),Basic Hindi (Antima),Hindi (Kusum),Maths (Nidhika),Maths (Nidhika),Home Work (Anjana),Sports (Rakesh)
Class 6,Science (Hemlata),Sanskrit (Jainendra),Maths (Nidhika),Maths (Nidhika),Sanskrit (Jainendra),SST (Rashmita),SST (Rashmita),Sports (Rakesh)
Class 7,Hindi (Jainendra),Maths (Leena),Maths (Leena),Science (Hemlata),Science (Hemlata),Sanskrit (Antima),SST (Gyan Sir),SST (Gyan Sir)
Class 8,Hindi (Antima),Science (Hemlata),Science (Hemlata),Maths (Leena),Sports (Rakesh),SST (Harshita),SST (Harshita),Sanskrit (Antima)
Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),Sanskrit (Antima),English (Harshita),Hindi (Jainendra),Sports (Rakesh),CCS (Maya)
Class 10,SST (Pradhyuman),Sanskrit (Antima),Maths (Nathulal),English (Harshita),Hindi (Antima),Science (Toshit),Sports (Rakesh),English (Harshita)
Class 11 Science,Physics (Phy Sir),Physics (Phy Sir),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata)
Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Business (Nidhika),Business (Nidhika)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),English (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy Sir),Physics (Phy Sir),Sports (Rakesh),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),English (Pradhyuman),Hindi (Jainendra)
Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),Self Study (Jainendra),Sports (Rakesh),Sports (Rakesh),English (Pradhyuman),Hindi (Jainendra)

Saturday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),EVS (Bindu),Hindi (Bindu),Hindi (Bindu),Sports (Rakesh Sir),Maths (Kusum),Home Work (Anjana),Home Work (Bindu)
Class 2,Maths (Anita),EVS (Rashmita),EVS (Rashmita),EVS (Rashmita),Sports (Rakesh Sir),CCS (Maya),Hindi (Bindu),Home Work (Anita)
Class 3,EVS (Rashmita),Maths (Anita),Hindi (Kusum),Hindi (Kusum),EVS (Rashmita),Home Work (Anjana),CCS (Maya),Home Work (Rashmita)
Class 4,Hindi (Kusum),Hindi (Kusum),EVS (Anita),EVS (Anita),Home Work (Anjana),Maths (Leena),Maths (Leena),Maths (Leena)
Class 5,Maths (Nidhika),Maths (Nidhika),CCS (Maya),EVS (Nidhika),EVS (Nidhika),Sports (Rakesh Sir),Hindi (Kusum),Home Work (Anjana)
Class 6,Science (Hemlata),Hindi (Jainendra),Maths (Nidhika),CCS (Maya),Sanskrit (Jainendra),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
Class 7,Hindi (Jainendra),Science (Hemlata),Science (Hemlata),Maths (Leena),SST (Gyan Sir),English Basic (Rashmita),SST (Gyan Sir),Sports (Rakesh)
Class 8,Hindi (Antima),Sanskrit (Antima),Maths (Leena),Science (Hemlata),CCS (Maya),SST (Harshita),SST (Harshita),Sports (Rakesh)
Class 9,Maths (Leena),Maths (Leena),Science (Toshit),Hindi (Jainendra),Maths (Leena),SST (Pradhyuman),Science (Toshit),English (Harshita)
Class 10,SST (Pradhyuman),SST (Pradhyuman),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),SST (Pradhyuman),Hindi (Antima)
Class 11 Science,Physics (Phy Sir),Physics (Phy Sir),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Biology (Hemlata),Sports (Rakesh)
Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Business (Nidhika)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Sports (Rakesh),Sports (Rakesh)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy Sir),Physics (Phy Sir),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman)
Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),English Literature (Harshita),Sports (Rakesh),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)
`;

// --- DATA PARSING & UTILITY FUNCTIONS ---
const parseTimetableData = () => {
  const timetable = {};
  const teacherDetails = {};
  let headers = [];

  const correctedData = rawData.replace(/\(Nindika\)/g, '(Nidhika)').replace(/\s+Sir/g, '');
  const dayBlocks = correctedData.trim().split(/\n\s*(?=Tuesday|Wednesday|Thursday|Friday|Saturday)/);

  dayBlocks.forEach((block, index) => {
    const lines = block.trim().split('\n');
    const day = lines[0].trim();
    timetable[day] = {};

    if (index === 0) {
      headers = lines[1].split(',').slice(1).map(h => {
          const parts = h.split('<br>');
          return { name: parts[0], time: parts[1] };
      });
    }

    const dataLines = lines.slice(2);
    dataLines.forEach(line => {
      const columns = line.split(',');
      const className = columns[0].trim();
      timetable[day][className] = [];

      columns.slice(1).forEach((cell, periodIndex) => {
        const match = cell.trim().match(/^(.*?)\s*\((.*?)\)$/);
        let entry = { subject: cell.trim(), teacher: null, period: periodIndex, className, day };
        if (match) {
          entry.subject = match[1].trim();
          entry.teacher = match[2].trim();
        }
        timetable[day][className].push(entry);

        if (entry.teacher) {
            const teachersInCell = entry.teacher.split('/').map(t => t.trim());
            const subjectsInCell = entry.subject.split('/').map(s => s.trim());

            teachersInCell.forEach((teacherName, i) => {
                if (!teacherDetails[teacherName]) {
                    teacherDetails[teacherName] = { schedule: {}, periodCount: 0 };
                }
                if (!teacherDetails[teacherName].schedule[day]) {
                    teacherDetails[teacherName].schedule[day] = Array(headers.length).fill(null);
                }
                const subjectForTeacher = subjectsInCell[i] || subjectsInCell[0];
                teacherDetails[teacherName].schedule[day][periodIndex] = { subject: subjectForTeacher, className };
                teacherDetails[teacherName].periodCount++;
            });
        }
      });
    });
  });

  const classNames = Object.keys(timetable.Monday).sort((a,b) => {
      const numA = parseInt(a.match(/\d+/)?.[0]);
      const numB = parseInt(b.match(/\d+/)?.[0]);
      if (!isNaN(numA) && !isNaN(numB) && numA !== numB) return numA - numB;
      return a.localeCompare(b);
  });
  
  return { timetable, teacherDetails, periodHeaders: headers, classNames, teacherNames: Object.keys(teacherDetails).sort() };
};

const allData = parseTimetableData();

// --- COMPONENTS ---

const StatCard = ({ icon, label, value, color }) => (
  <div className="bg-white p-4 rounded-xl shadow-md flex items-center">
    <div className={`rounded-full p-3 mr-4 ${color}`}>
      {icon}
    </div>
    <div>
      <p className="text-sm text-gray-500 font-medium">{label}</p>
      <p className="text-2xl font-bold text-gray-800">{value}</p>
    </div>
  </div>
);

const FreeTeacherFinder = ({ teacherDetails, substitutions }) => {
    const [day, setDay] = useState(new Date().toLocaleDateString('en-US', { weekday: 'long' }));
    const [period, setPeriod] = useState(1);
    const [freeTeachers, setFreeTeachers] = useState([]);

    useEffect(() => {
        const periodIndex = period - 1;

        const absentToday = Object.keys(substitutions[day]?.plan || {}).flatMap(className => 
            Object.keys(substitutions[day].plan[className]).map(pIndex => 
                allData.timetable[day][className][pIndex].teacher
            )
        ).filter((value, index, self) => self.indexOf(value) === index);

        const free = allData.teacherNames.filter(teacher => {
            if (absentToday.includes(teacher)) return false;
            
            // --- Teacher Constraint Rules ---
            if (teacher === 'Gyan') return false; 
            if (teacher === 'Phy' && periodIndex > 3) return false;
            if (teacher === 'Anjana' && periodIndex < 4) return false;

            if (teacherDetails[teacher]?.schedule[day]?.[periodIndex]) return false;
            
            let isSubstituting = false;
            for (const cName in (substitutions[day]?.plan || {})) {
                if (substitutions[day].plan[cName][periodIndex] === teacher) {
                    isSubstituting = true;
                    break;
                }
            }
            if(isSubstituting) return false;

            return true;
        });
        setFreeTeachers(free);
    }, [day, period, substitutions, teacherDetails]);

    return (
        <div className="bg-white p-6 rounded-xl shadow-md">
            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Search size={20} className="mr-2" /> Live Free Teacher Finder</h3>
            <div className="flex gap-4 mb-4">
                <select value={day} onChange={e => setDay(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg">
                    {Object.keys(allData.timetable).map(d => <option key={d} value={d}>{d}</option>)}
                </select>
                <select value={period} onChange={e => setPeriod(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg">
                    {allData.periodHeaders.map((p, i) => <option key={i} value={i+1}>{p.name}</option>)}
                </select>
            </div>
            <div className="space-y-2 max-h-48 overflow-y-auto pr-2">
                {freeTeachers.length > 0 ? freeTeachers.map(t => (
                    <div key={t} className="bg-green-100 text-green-800 p-2 rounded-md text-sm font-semibold">{t}</div>
                )) : <div className="text-gray-500">No teachers are free.</div>}
            </div>
        </div>
    );
};


const Dashboard = ({ substitutions, teacherDetails }) => {
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
    
    const substitutionCount = useMemo(() => {
        return Object.values(substitutions[today]?.plan || {}).reduce((acc, classSubs) => acc + Object.keys(classSubs).length, 0);
    }, [substitutions, today]);

    const workloadData = useMemo(() => {
        return allData.teacherNames.map(name => ({
            name,
            periods: teacherDetails[name].periodCount
        })).sort((a,b) => b.periods - a.periods);
    }, [teacherDetails]);

    return (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <StatCard icon={<Calendar size={24} className="text-white"/>} label="Today's Date" value={new Date().toLocaleDateString('en-GB')} color="bg-blue-500" />
                <StatCard icon={<Clapperboard size={24} className="text-white"/>} label="Total Classes Today" value={Object.values(allData.timetable[today] || {}).flat().filter(p => p.teacher).length} color="bg-green-500"/>
                <StatCard icon={<Users size={24} className="text-white"/>} label="Teachers on Duty" value={allData.teacherNames.length} color="bg-yellow-500"/>
                <StatCard icon={<UserCheck size={24} className="text-white"/>} label="Substitutions Made" value={substitutionCount} color="bg-red-500"/>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                     <h3 className="text-lg font-bold text-gray-800 mb-4">Weekly Workload Distribution</h3>
                     <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={workloadData} margin={{ top: 5, right: 20, left: -10, bottom: 50 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" angle={-45} textAnchor="end" interval={0} height={60} />
                            <YAxis allowDecimals={false} />
                            <Tooltip />
                            <Legend />
                            <Bar dataKey="periods" name="Weekly Periods" fill="#4f46e5" />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
                <FreeTeacherFinder teacherDetails={teacherDetails} substitutions={substitutions} />
            </div>
        </div>
    );
};

const MultiSelectDropdown = ({ options, selectedOptions, onChange }) => {
    const [isOpen, setIsOpen] = useState(false);

    const handleSelect = (option) => {
        const newSelection = selectedOptions.includes(option)
            ? selectedOptions.filter(item => item !== option)
            : [...selectedOptions, option];
        onChange(newSelection);
    };

    return (
        <div className="relative">
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white flex justify-between items-center"
            >
                <span>{selectedOptions.length > 0 ? `${selectedOptions.length} selected` : 'Select teachers...'}</span>
                {isOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
            </button>
            {isOpen && (
                <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    {options.map(option => (
                        <label key={option} className="flex items-center space-x-3 p-2 hover:bg-gray-100 cursor-pointer">
                            <input
                                type="checkbox"
                                checked={selectedOptions.includes(option)}
                                onChange={() => handleSelect(option)}
                                className="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                            />
                            <span>{option}</span>
                        </label>
                    ))}
                </div>
            )}
        </div>
    );
};

const SubstitutionView = ({ teacherDetails, substitutions, setSubstitutions }) => {
    const [day, setDay] = useState('Monday');
    const [absentTeachers, setAbsentTeachers] = useState([]);
    const [plan, setPlan] = useState([]);
    const [screenshotUrl, setScreenshotUrl] = useState(null);
    const [isScreenshotting, setIsScreenshotting] = useState(false);
    const planRef = useRef(null);

    const findFreeTeachers = (day, periodIndex, absentTeachers, currentDaySubs, currentSubForSlot = null) => {
        const free = [];
        for (const teacher of allData.teacherNames) {
            // --- Teacher Constraint Rules ---
            if (absentTeachers.includes(teacher)) continue; 
            if (teacher === 'Gyan') continue; 
            if (teacher === 'Phy' && periodIndex > 3) continue;
            if (teacher === 'Anjana' && periodIndex < 4) continue;

            const isBusyInSchedule = teacherDetails[teacher]?.schedule[day]?.[periodIndex];
            if (isBusyInSchedule) continue;

            let isBusyAsSub = false;
            for (const cName in currentDaySubs) {
                if (currentDaySubs[cName][periodIndex] === teacher && teacher !== currentSubForSlot) {
                    isBusyAsSub = true;
                    break;
                }
            }
            if (isBusyAsSub) continue;
            
            free.push(teacher);
        }
        return free.sort();
    };
    
    const handleGeneratePlan = () => {
        if (absentTeachers.length === 0) {
            alert("Please select at least one absent teacher.");
            return;
        }

        const vacantSlots = [];
        absentTeachers.forEach(absentTeacher => {
            const schedule = teacherDetails[absentTeacher]?.schedule[day];
            if (schedule) {
                schedule.forEach((period, periodIndex) => {
                    if (period) {
                        vacantSlots.push({ ...period, periodIndex, originalTeacher: absentTeacher });
                    }
                });
            }
        });

        const newDaySubstitutions = {};
        const subLoad = allData.teacherNames.reduce((acc, t) => ({...acc, [t]: 0}), {});

        vacantSlots.sort((a,b) => a.periodIndex - b.periodIndex).forEach(slot => {
            let freeTeachers = findFreeTeachers(day, slot.periodIndex, absentTeachers, newDaySubstitutions);
            
            freeTeachers.sort((a,b) => subLoad[a] - subLoad[b]);

            if (freeTeachers.length > 0) {
                const substitute = freeTeachers[0];
                if (!newDaySubstitutions[slot.className]) {
                    newDaySubstitutions[slot.className] = {};
                }
                newDaySubstitutions[slot.className][slot.periodIndex] = substitute;
                subLoad[substitute]++;
            }
        });
        
        setSubstitutions(prev => ({ ...prev, [day]: { plan: newDaySubstitutions, timestamp: Date.now() } }));
    };
    
    useEffect(() => {
        const daySubsData = substitutions[day]?.plan || {};
        const vacantSlots = [];
         absentTeachers.forEach(absentTeacher => {
            const schedule = teacherDetails[absentTeacher]?.schedule[day];
            if (schedule) {
                schedule.forEach((period, periodIndex) => {
                    if (period) {
                        vacantSlots.push({ ...period, periodIndex, originalTeacher: absentTeacher });
                    }
                });
            }
        });
        
        const newPlan = vacantSlots.map(slot => {
            const substitute = daySubsData[slot.className]?.[slot.periodIndex];
            const freeTeachers = findFreeTeachers(day, slot.periodIndex, absentTeachers, daySubsData, substitute);
            return { ...slot, substitute, freeTeachers };
        }).sort((a, b) => a.periodIndex - b.periodIndex);

        setPlan(newPlan);

    }, [substitutions, day, absentTeachers, teacherDetails]);

    const handleManualAssignment = (className, periodIndex, newSubstitute) => {
        setSubstitutions(prev => {
            const newSubs = JSON.parse(JSON.stringify(prev));
            if (!newSubs[day]) newSubs[day] = { plan: {}, timestamp: Date.now() };
            if (!newSubs[day].plan[className]) newSubs[day].plan[className] = {};
            
            if (newSubstitute) {
                newSubs[day].plan[className][periodIndex] = newSubstitute;
            } else {
                delete newSubs[day].plan[className][periodIndex];
            }
            newSubs[day].timestamp = Date.now();
            return newSubs;
        });
    };
    
    const handleReset = () => {
        setSubstitutions(prev => {
            const newSubs = { ...prev };
            delete newSubs[day];
            return newSubs;
        });
        setAbsentTeachers([]);
        setPlan([]);
    };

    const handleScreenshot = async () => {
        if (!planRef.current || !window.html2canvas) {
            alert("Screenshot tool is not ready.");
            return;
        }
        setIsScreenshotting(true);
        try {
            const canvas = await window.html2canvas(planRef.current, {
                useCORS: true,
                backgroundColor: '#ffffff',
                scale: 2,
            });
            const dataUrl = canvas.toDataURL('image/png');
            
            const blob = await (await fetch(dataUrl)).blob();
            const file = new File([blob], `substitution-plan-${day}.png`, { type: 'image/png' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: `Substitution Plan for ${day}`,
                    text: `Here is the teacher substitution plan for ${day}.`,
                });
            } else {
                setScreenshotUrl(dataUrl);
            }
        } catch (error) {
            console.error("Screenshot failed:", error);
            alert("Could not generate screenshot.");
        } finally {
            setIsScreenshotting(false);
        }
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-md space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <div>
                    <label className="block font-semibold text-gray-700 mb-2">1. Select Day</label>
                    <select value={day} onChange={e => setDay(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                        {Object.keys(allData.timetable).map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                </div>
                <div>
                    <label className="block font-semibold text-gray-700 mb-2">2. Select Absent Teachers</label>
                    <MultiSelectDropdown options={allData.teacherNames} selectedOptions={absentTeachers} onChange={setAbsentTeachers} />
                </div>
            </div>
            <div className="text-center border-t pt-6">
                <button onClick={handleGeneratePlan} className="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition shadow-lg text-lg">
                    Generate & Auto-Assign Plan
                </button>
                <button onClick={handleReset} className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition shadow-md ml-4">
                    Reset for {day}
                </button>
            </div>

            {plan.length > 0 && (
                <div className="mt-8">
                    <div ref={planRef} className="p-4 bg-white screenshot-area">
                        <h3 className="text-xl font-bold text-center mb-4 text-gray-800">Consolidated Substitution Plan for {day}</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left screenshot-table">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-3 font-semibold">Period</th>
                                        <th className="p-3 font-semibold">Class</th>
                                        <th className="p-3 font-semibold">Subject</th>
                                        <th className="p-3 font-semibold">Original Teacher</th>
                                        <th className="p-3 font-semibold">Assigned Substitute</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {plan.map((slot, i) => (
                                        <tr key={i} className="border-b">
                                            <td className="p-2 font-medium">{allData.periodHeaders[slot.periodIndex].name}</td>
                                            <td className="p-2 font-medium">{slot.className}</td>
                                            <td className="p-2">{slot.subject}</td>
                                            <td className="p-2 text-red-600 font-bold original-teacher-screenshot">{slot.originalTeacher}</td>
                                            <td className="p-2 text-green-700 font-bold substitute-teacher-screenshot">
                                                {slot.substitute || '--'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="text-center mt-6">
                        <button onClick={handleScreenshot} disabled={isScreenshotting} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition shadow-md inline-flex items-center">
                            <Camera size={18} className="mr-2"/>
                            {isScreenshotting ? 'Generating...' : 'Share Plan'}
                        </button>
                    </div>
                </div>
            )}
            
            {screenshotUrl && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl p-4 max-w-lg w-full">
                         <div className="flex justify-between items-center mb-4">
                            <h4 className="font-bold">Substitution Plan Screenshot</h4>
                            <button onClick={() => setScreenshotUrl(null)} className="p-1 rounded-full hover:bg-gray-200"><X size={20}/></button>
                        </div>
                        <img src={screenshotUrl} alt="Substitution Plan Screenshot" className="w-full rounded-md border"/>
                        <div className="mt-4 text-center">
                            <a href={screenshotUrl} download={`substitution-plan-${day}.png`} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition shadow-md">
                                Download
                            </a>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const DayView = ({ timetable, substitutions }) => {
    const [day, setDay] = useState('Monday');

    return (
        <div className="bg-white p-6 rounded-xl shadow-md space-y-4">
            <div className="flex items-center gap-4">
                <Calendar size={24} className="text-indigo-600"/>
                <h2 className="text-2xl font-bold text-gray-800">View by Day</h2>
            </div>
            <div className="flex flex-wrap gap-2 border-b pb-2">
                {Object.keys(timetable).map(d => (
                    <button key={d} onClick={() => setDay(d)} className={`px-4 py-2 rounded-md font-semibold text-sm transition ${day === d ? 'bg-indigo-600 text-white' : 'hover:bg-indigo-100'}`}>
                        {d}
                    </button>
                ))}
            </div>
            <div className="overflow-x-auto mt-4">
                <table className="w-full text-sm text-left border-collapse">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="p-3 font-semibold">Class</th>
                            {allData.periodHeaders.map(h => <th key={h.name} className="p-3 font-semibold">{h.name}<br/><span className="text-xs font-normal text-gray-500">{h.time}</span></th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {allData.classNames.map(cName => (
                            <tr key={cName} className="border-b">
                                <td className="p-2 font-bold">{cName}</td>
                                {timetable[day][cName].map((period, i) => {
                                    const substitute = substitutions[day]?.plan?.[cName]?.[i];
                                    return (
                                        <td key={i} className="p-2">
                                            <div className="font-semibold text-blue-900">{period.subject}</div>
                                            {period.teacher && (
                                                <div className={`text-xs ${substitute ? 'line-through' : ''}`}>{period.teacher}</div>
                                            )}
                                            {substitute && (
                                                <div className="text-xs font-bold text-red-600">Sub: {substitute}</div>
                                            )}
                                        </td>
                                    );
                                })}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const ClassView = ({ timetable, substitutions }) => {
    const [selectedClass, setSelectedClass] = useState('');

    return (
        <div className="bg-white p-6 rounded-xl shadow-md space-y-4">
            <div className="flex items-center gap-4">
                <School size={24} className="text-indigo-600"/>
                <h2 className="text-2xl font-bold text-gray-800">View by Class</h2>
            </div>
            <select onChange={e => setSelectedClass(e.target.value)} value={selectedClass} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg shadow-sm">
                <option value="">-- Select a Class --</option>
                {allData.classNames.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            {selectedClass && (
                <div className="overflow-x-auto mt-4">
                    <table className="w-full text-sm text-left border-collapse">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="p-3 font-semibold">Day</th>
                                {allData.periodHeaders.map(h => <th key={h.name} className="p-3 font-semibold">{h.name}<br/><span className="text-xs font-normal text-gray-500">{h.time}</span></th>)}
                            </tr>
                        </thead>
                        <tbody>
                            {Object.keys(timetable).map(day => (
                                <tr key={day} className="border-b">
                                    <td className="p-2 font-bold">{day}</td>
                                    {timetable[day][selectedClass].map((period, i) => {
                                        const substitute = substitutions[day]?.plan?.[selectedClass]?.[i];
                                        return (
                                            <td key={i} className="p-2">
                                                <div className="font-semibold text-blue-900">{period.subject}</div>
                                                {period.teacher && (
                                                    <div className={`text-xs ${substitute ? 'line-through' : ''}`}>{period.teacher}</div>
                                                )}
                                                {substitute && (
                                                    <div className="text-xs font-bold text-red-600">Sub: {substitute}</div>
                                                )}
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

const TeacherView = ({ teacherDetails, substitutions }) => {
    const [selectedTeacher, setSelectedTeacher] = useState('');
    const teacherWorkloadData = useMemo(() => {
        if (!selectedTeacher) return [];
        const totalPeriods = allData.teacherNames.reduce((acc, t) => acc + teacherDetails[t].periodCount, 0);
        const avgPeriods = totalPeriods / allData.teacherNames.length;
        return [
            { name: 'Selected Teacher', periods: teacherDetails[selectedTeacher].periodCount },
            { name: 'Average', periods: parseFloat(avgPeriods.toFixed(1)) },
        ];
    }, [selectedTeacher, teacherDetails]);


    return (
        <div className="bg-white p-6 rounded-xl shadow-md space-y-4">
            <div className="flex items-center gap-4">
                <Users size={24} className="text-indigo-600"/>
                <h2 className="text-2xl font-bold text-gray-800">View by Teacher</h2>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                <select onChange={e => setSelectedTeacher(e.target.value)} value={selectedTeacher} className="md:col-span-2 w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                    <option value="">-- Select a Teacher --</option>
                    {allData.teacherNames.map(t => <option key={t} value={t}>{t}</option>)}
                </select>
                {selectedTeacher && (
                     <div className="p-3 h-full bg-indigo-100 rounded-lg text-indigo-800 font-semibold flex items-center justify-center">
                        Weekly Periods: {teacherDetails[selectedTeacher].periodCount}
                    </div>
                )}
            </div>
             {selectedTeacher && (
                <div className="mt-4">
                    <h4 className="font-bold text-center mb-2">Workload vs. Average</h4>
                    <ResponsiveContainer width="100%" height={100}>
                        <BarChart layout="vertical" data={teacherWorkloadData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                            <XAxis type="number" />
                            <YAxis type="category" dataKey="name" width={100}/>
                            <Tooltip />
                            <Bar dataKey="periods" fill="#818cf8" background={{ fill: '#eee' }} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            )}
            {selectedTeacher && (
                <div className="overflow-x-auto mt-4">
                    <table className="w-full text-sm text-left border-collapse">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="p-3 font-semibold">Day</th>
                                {allData.periodHeaders.map(h => <th key={h.name} className="p-3 font-semibold">{h.name}</th>)}
                            </tr>
                        </thead>
                        <tbody>
                            {Object.keys(allData.timetable).map(day => (
                                <tr key={day} className="border-b">
                                    <td className="p-2 font-bold">{day}</td>
                                    {allData.periodHeaders.map((h, i) => {
                                        const originalPeriod = teacherDetails[selectedTeacher]?.schedule[day]?.[i];
                                        const isSubstitutedOut = originalPeriod && substitutions[day]?.plan?.[originalPeriod.className]?.[i];
                                        
                                        let subPeriod = null;
                                        for (const cName in (substitutions[day]?.plan || {})) {
                                            if (substitutions[day].plan[cName][i] === selectedTeacher) {
                                                subPeriod = allData.timetable[day][cName][i];
                                                break;
                                            }
                                        }

                                        return (
                                            <td key={i} className="p-2">
                                                {originalPeriod && (
                                                    <div className={isSubstitutedOut ? 'line-through text-gray-400' : ''}>
                                                        <div className="font-semibold text-blue-900">{originalPeriod.subject}</div>
                                                        <div className="text-xs">{originalPeriod.className}</div>
                                                    </div>
                                                )}
                                                {subPeriod && (
                                                    <div className="mt-1 text-red-600">
                                                        <div className="font-semibold">{subPeriod.subject}</div>
                                                        <div className="text-xs">(Sub for {subPeriod.teacher})</div>
                                                        <div className="text-xs">{subPeriod.className}</div>
                                                    </div>
                                                )}
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};


// --- MAIN APP COMPONENT ---
export default function App() {
    const [view, setView] = useState('Dashboard');
    const [substitutions, setSubstitutions] = useState({});
    const [scriptsLoaded, setScriptsLoaded] = useState(false);
    
    // Auto-reset substitutions after 12 hours
    useEffect(() => {
        const interval = setInterval(() => {
            const now = Date.now();
            const twelveHours = 12 * 60 * 60 * 1000;
            let needsUpdate = false;
            const updatedSubs = Object.entries(substitutions).reduce((acc, [day, data]) => {
                if (now - data.timestamp < twelveHours) {
                    acc[day] = data;
                } else {
                    needsUpdate = true;
                    console.log(`Auto-resetting substitutions for ${day}.`);
                }
                return acc;
            }, {});

            if (needsUpdate) {
                setSubstitutions(updatedSubs);
            }
        }, 60 * 60 * 1000); // Check every hour

        return () => clearInterval(interval);
    }, [substitutions]);

    const PrintStyles = () => (
        <style>{`
            @media print {
                body {
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                .app-container {
                    padding: 0 !important;
                }
                header, nav, footer {
                    display: none !important;
                }
                main {
                    padding: 0 !important;
                }
                .bg-white, .bg-gray-50, .bg-indigo-100 {
                    background-color: transparent !important;
                    box-shadow: none !important;
                    border: none !important;
                }
                .shadow-md, .shadow-lg {
                    box-shadow: none !important;
                }
                table {
                    width: 100% !important;
                    border-collapse: collapse !important;
                    font-size: 10px;
                }
                th, td {
                    border: 1px solid #ccc !important;
                    padding: 4px !important;
                }
                .overflow-x-auto {
                    overflow: visible !important;
                }
                .text-red-500 { color: #ef4444 !important; }
                .text-red-600 { color: #dc2626 !important; }
                .text-blue-900 { color: #1e3a8a !important; }
                .font-bold { font-weight: 700 !important; }
            }
            .screenshot-area .screenshot-table {
                font-size: 16px;
            }
            .screenshot-area .original-teacher-screenshot, .screenshot-area .substitute-teacher-screenshot {
                font-size: 18px;
                font-weight: 700;
            }
        `}</style>
    );

    const NavButton = ({ currentView, targetView, icon, children }) => (
        <button
            onClick={() => setView(targetView)}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200 ${
                currentView === targetView
                    ? 'bg-indigo-600 text-white shadow-md'
                    : 'text-gray-600 hover:bg-indigo-100 hover:text-indigo-600'
            }`}
        >
            {icon}
            <span className="font-semibold">{children}</span>
        </button>
    );
    
    const renderView = () => {
        switch(view) {
            case 'Dashboard': return <Dashboard substitutions={substitutions} teacherDetails={allData.teacherDetails} />;
            case 'Day': return <DayView timetable={allData.timetable} substitutions={substitutions} />;
            case 'Class': return <ClassView timetable={allData.timetable} substitutions={substitutions} />;
            case 'Teacher': return <TeacherView teacherDetails={allData.teacherDetails} substitutions={substitutions} />;
            case 'Substitution': return <SubstitutionView teacherDetails={allData.teacherDetails} substitutions={substitutions} setSubstitutions={setSubstitutions} />;
            default: return <Dashboard substitutions={substitutions} teacherDetails={allData.teacherDetails}/>;
        }
    }

    return (
        <>
            <ScriptLoader onLoaded={() => setScriptsLoaded(true)} />
            <PrintStyles />
            <div className="antialiased text-gray-800 bg-gray-100 min-h-screen p-4 md:p-8 app-container">
                <div className="max-w-screen-xl mx-auto">
                    <header>
                        <div className="text-center">
                            <h1 className="text-4xl md:text-5xl font-bold text-gray-900">Timetable Command Center</h1>
                            <p className="text-lg text-gray-600 mt-2">Veer Patta Public School, Amet</p>
                        </div>
                         <div className="mt-6 text-center">
                            <button onClick={() => window.print()} className="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800 transition duration-300 ease-in-out shadow-md inline-flex items-center">
                                <Printer size={18} className="mr-2"/>
                                Print View
                            </button>
                        </div>
                    </header>

                    <nav className="my-8 p-2 bg-white/60 backdrop-blur-sm rounded-xl shadow-md flex flex-wrap justify-center gap-2">
                        <NavButton currentView={view} targetView="Dashboard" icon={<PieChart size={18}/>}>Dashboard</NavButton>
                        <NavButton currentView={view} targetView="Day" icon={<Calendar size={18}/>}>Day View</NavButton>
                        <NavButton currentView={view} targetView="Substitution" icon={<UserCheck size={18}/>}>Substitutions</NavButton>
                        <NavButton currentView={view} targetView="Class" icon={<School size={18}/>}>Class View</NavButton>
                        <NavButton currentView={view} targetView="Teacher" icon={<Users size={18}/>}>Teacher View</NavButton>
                    </nav>

                    <main className="p-1">
                        {renderView()}
                    </main>
                     <footer className="text-center text-sm text-gray-500 mt-12">
                        <p>This interactive dashboard is an AI-driven upgrade for modern school administration.</p>
                    </footer>
                </div>
            </div>
        </>
    );
}
